<!DOCTYPE html>
<html>

<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/addons/p5.sound.min.js"></script>
    <meta charset="utf-8" />
    <title>Salocin</title>
    <script src="tools_graphics.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
</head>

<body>
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        .btn {
            margin: 3px;
        }

        #menu-inicio {
            position: absolute;
            z-index: 1;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(2px);
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
    </style>

    <div id="menu-inicio">
        <div style="border: 1px solid black;padding: 30px;background: rgba(255, 255, 255, 0.3);">
            Aquí va el logo
        </div>
        <div style="padding: 5px;text-align: center;">
            <span class="btn btn-light">
                Reanudar
            </span>
            <br>
            <span class="btn btn-light">
                Salir
            </span>
        </div>
    </div>
    <script>

        ESCALA_UNIDAD = 50


        class Jugador {
            constructor() {
                this.x = 0
                this.y = 0
                this.w = ESCALA_UNIDAD
                this.h = ESCALA_UNIDAD
                this.movimiento = createVector(0, 0)
                this.dirección = DOWN_ARROW
                this.mover = false
                //Eventos de roll
                this.roll = undefined
                this.rollDuration = 100
                this.startRoll = 0
            }

            keysLogic() {
                if (keyIsDown(SHIFT) && !this.roll) {
                    if (keyIsDown(DOWN_ARROW)) {
                        this.roll = DOWN_ARROW
                    }
                    if (keyIsDown(UP_ARROW)) {
                        this.roll = UP_ARROW
                    }
                    if (keyIsDown(RIGHT_ARROW)) {
                        this.roll = RIGHT_ARROW
                    }
                    if (keyIsDown(LEFT_ARROW)) {
                        this.roll = LEFT_ARROW
                    }
                    if (this.roll) {
                        this.startRoll = millis()
                    }
                }
                if (keyIsDown(RIGHT_ARROW)) {
                    this.movimiento.x += 2
                    if (!this.mover) {
                        this.dirección = RIGHT_ARROW
                        this.mover = true
                    }
                }
                if (keyIsDown(LEFT_ARROW)) {
                    this.movimiento.x -= 2
                    if (!this.mover) {
                        this.dirección = LEFT_ARROW
                        this.mover = true
                    }
                }
                if (keyIsDown(UP_ARROW)) {
                    this.movimiento.y -= 2
                    if (!this.mover) {
                        this.dirección = UP_ARROW
                        this.mover = true
                    }
                }
                if (keyIsDown(DOWN_ARROW)) {
                    this.movimiento.y += 2
                    if (!this.mover) {
                        this.dirección = DOWN_ARROW
                        this.mover = true
                    }
                }
                if (!this.roll) {
                    this.movimiento.x = constrain(this.movimiento.x, -2, 2)
                    this.movimiento.y = constrain(this.movimiento.y, -2, 2)
                } else {
                    switch (this.roll) {
                        case DOWN_ARROW:
                            this.movimiento = createVector(0, 10)
                            break;
                        case UP_ARROW:
                            this.movimiento = createVector(0, -10)
                            break;
                        case RIGHT_ARROW:
                            this.movimiento = createVector(10, 0)
                            break;
                        case LEFT_ARROW:
                            this.movimiento = createVector(-10, 0)
                            break;
                    }
                    if (millis() - this.startRoll > this.rollDuration) {
                        this.roll = undefined
                        this.movimiento = createVector(0, 0)
                    }
                }
            }

            keyReleased() {
                if (keyCode == RIGHT_ARROW) {
                    if (this.dirección == RIGHT_ARROW) {
                        this.mover = false
                    }
                    this.movimiento.x = 0
                }
                if (keyCode == LEFT_ARROW) {
                    if (this.dirección == LEFT_ARROW) {
                        this.mover = false
                    }
                    this.movimiento.x = 0
                }
                if (keyCode == UP_ARROW) {
                    if (this.dirección == UP_ARROW) {
                        this.mover = false
                    }
                    this.movimiento.y = 0
                }
                if (keyCode == DOWN_ARROW) {
                    if (this.dirección == DOWN_ARROW) {
                        this.mover = false
                    }
                    this.movimiento.y = 0
                }
            }

            draw() {
                push()

                this.keysLogic()

                this.x += this.movimiento.x
                this.y += this.movimiento.y

                translate(this.x, this.y)

                let sprite = sprites.personaje.quieto.derecha

                if (this.mover) {
                    if (this.dirección == RIGHT_ARROW) {
                        sprite = sprites.personaje.caminando.derecha
                    }
                    if (this.dirección == LEFT_ARROW) {
                        sprite = sprites.personaje.caminando.izquierda
                    }
                    if (this.dirección == DOWN_ARROW) {
                        sprite = sprites.personaje.caminando.abajo
                    }
                    if (this.dirección == UP_ARROW) {
                        sprite = sprites.personaje.caminando.arriba
                    }
                    if (sprite.numFrames()) {
                        sprite.setFrame(Math.floor(sprite.aframe))
                        sprite.aframe = (sprite.aframe + 0.2) % sprite.numFrames()
                    }
                    if (this.roll) {
                        if (sprite.numFrames()) {
                            sprite.setFrame(Math.floor(sprite.aframe))
                            sprite.aframe = (sprite.aframe + 1) % sprite.numFrames()
                        }
                    }

                } else {
                    if (this.dirección == RIGHT_ARROW) {
                        sprite = sprites.personaje.quieto.derecha
                    }
                    if (this.dirección == LEFT_ARROW) {
                        sprite = sprites.personaje.quieto.izquierda
                    }
                    if (this.dirección == DOWN_ARROW) {
                        sprite = sprites.personaje.quieto.abajo
                    }
                    if (this.dirección == UP_ARROW) {
                        sprite = sprites.personaje.quieto.arriba
                    }

                    if (millis() - sprites.personaje.quieto.parpadeo > 5000) {
                        if (sprite.numFrames()) {
                            if (sprite.aframe < sprite.numFrames()) {
                                sprite.aframe = sprite.aframe + 0.2
                            } else {
                                sprites.personaje.quieto.parpadeo = millis()
                                sprite.aframe = 0
                            }
                        }
                    }

                    sprite.setFrame(Math.floor(sprite.aframe))
                }

                rectMode(CENTER)
                stroke("white")
                noFill()
                rect(0, 0, this.w, this.h)

                image(
                    sprite,
                    - this.w / 2,
                    - this.h / 2,
                    this.w,
                    this.h
                )
                if (this.roll) {
                    push()
                    blendMode(SCREEN)
                    fill("white")
                    var gradient = drawingContext.createLinearGradient(this.w / 2, this.h / 2, -this.w / 2, this.h / 2);
                    gradient.addColorStop(0, 'white');
                    gradient.addColorStop(.1, 'yellow');
                    gradient.addColorStop(.2, 'orange');
                    gradient.addColorStop(1, 'transparent');
                    drawingContext.fillStyle = gradient;
                    noStroke()
                    if (this.roll == UP_ARROW) {
                        rotate(-PI / 2)
                    }
                    if (this.roll == LEFT_ARROW) {
                        rotate(PI)
                    }
                    if (this.roll == DOWN_ARROW) {
                        rotate(PI / 2)
                    }
                    circle(0, 0, this.w)
                    pop()
                }
                pop()
            }
        }

        function preload() {
            sprites = {
                mapa: loadImage("imgs/Mapa.jfif"),
                personaje: {
                    quieto: {
                        parpadeo: millis(),
                        arriba: loadImage("imgs/parpadeando-arriba.png"),
                        derecha: loadImage("imgs/parpadeando-derecha.gif"),
                        abajo: loadImage("imgs/parpadeando-abajo.gif"),
                        izquierda: loadImage("imgs/parpadeando-izquierda.gif"),
                    },
                    caminando: {
                        arriba: loadImage("imgs/caminando-arriba.gif"),
                        derecha: loadImage("imgs/caminando-derecha.gif"),
                        abajo: loadImage("imgs/caminando-abajo.gif"),
                        izquierda: loadImage("imgs/caminando-izquierda.gif")
                    },
                    roll: {
                        arriba: loadImage("imgs/roll-arriba.gif"),
                        derecha: loadImage("imgs/roll-derecha.gif"),
                        abajo: loadImage("imgs/roll-abajo.gif"),
                        izquierda: loadImage("imgs/roll-izquierda.gif")
                    }
                }
            }
        }

        function windowResized() {
            css_canvas()
        }

        function css_canvas() {
            let horizontal = windowWidth > windowHeight
            let w, h

            if (horizontal) {
                h = 384
                w = h * 16 / 9
            } else {
                w = 384
                h = w * 16 / 9
            }

            resizeCanvas(
                w,
                h
            );
            let x = (windowWidth - width) / 2
            let y = (windowHeight - height) / 2
            canvas.position(x, y)

            let sx = windowWidth / width
            let sy = windowHeight / height
            s = min(sx, sy)
            canvas.style(
                "transform",
                "scale(" + s + ")"
            )
            document.getElementById("menu-inicio").style.transformOrigin = "center center"
            document.getElementById("menu-inicio").style.transform = `scale(${s})`
            document.getElementById("menu-inicio").style.width = width + "px"
            document.getElementById("menu-inicio").style.height = height + "px"
            document.getElementById("menu-inicio").style.left = x + "px"
            document.getElementById("menu-inicio").style.top = y + "px"
        }

        function setup() {
            canvas = createCanvas(1280, 720)
            pixelDensity(1)
            sprites.personaje.quieto.derecha.aframe = 0
            sprites.personaje.quieto.izquierda.aframe = 0
            sprites.personaje.quieto.abajo.aframe = 0
            sprites.personaje.quieto.arriba.aframe = 0
            sprites.personaje.caminando.derecha.aframe = 0
            sprites.personaje.caminando.izquierda.aframe = 0
            sprites.personaje.caminando.abajo.aframe = 0
            sprites.personaje.caminando.arriba.aframe = 0
            jugador = new Jugador()
            css_canvas()
            noSmooth()
        }

        function draw() {
            background("lightgray")
            push()
            translate(width / 2, height / 2)
            image(sprites.mapa, -sprites.mapa.width / 2 - jugador.x, -sprites.mapa.height / 2 - jugador.y)
            translate(-jugador.x, -jugador.y)
            jugador.draw()
            pop()
        }

        function keyPressed() {
            //jugador.keyPressed()
            if (keyCode == ESCAPE) {
                let menu_inicio = document.getElementById("menu-inicio")
                let menu_inicio_display = menu_inicio.style.display
                if (menu_inicio_display == "flex") {
                    menu_inicio.style.display = "none"
                    loop()
                } else {
                    menu_inicio.style.display = "flex"
                    noLoop()
                }
            }
        }

        function keyReleased() {
            jugador.keyReleased()
        }
    </script>
</body>

</html>