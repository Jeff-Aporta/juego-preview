<!DOCTYPE html>
<html>

<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/addons/p5.sound.min.js"></script>
    <meta charset="utf-8" />
    <title>Salocin</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">

    <script src="tools_graphics.js"></script>
    <script src="Jugador.js"></script>
    <script src="mapas.js"></script>
    <script src="interprete_mapa.js"></script>
</head>

<body>
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        .btn {
            margin: 3px;
        }

        #menu-inicio {
            position: absolute;
            z-index: 1;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(2px);
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
    </style>

    <div id="menu-inicio">
        <div style="border: 1px solid black;padding: 30px;background: rgba(255, 255, 255, 0.3);">
            Aquí va el logo
        </div>
        <div style="padding: 5px;text-align: center;">
            <span class="btn btn-light">
                Reanudar
            </span>
            <br>
            <span class="btn btn-light">
                Salir
            </span>
        </div>
    </div>
    <script>

        ESCALA_UNIDAD = 50


        function preload() {
            sprites = {
                personaje: {
                    quieto: {
                        parpadeo: millis(),
                        arriba: loadImage("imgs/parpadeando-arriba.png"),
                        derecha: loadImage("imgs/parpadeando-derecha.gif"),
                        abajo: loadImage("imgs/parpadeando-abajo.gif"),
                        izquierda: loadImage("imgs/parpadeando-izquierda.gif"),
                    },
                    caminando: {
                        arriba: loadImage("imgs/caminando-arriba.gif"),
                        derecha: loadImage("imgs/caminando-derecha.gif"),
                        abajo: loadImage("imgs/caminando-abajo.gif"),
                        izquierda: loadImage("imgs/caminando-izquierda.gif")
                    },
                    roll: {
                        arriba: loadImage("imgs/roll-arriba.gif"),
                        derecha: loadImage("imgs/roll-derecha.gif"),
                        abajo: loadImage("imgs/roll-abajo.gif"),
                        izquierda: loadImage("imgs/roll-izquierda.gif")
                    }
                }
            }
            let tiles = {}
            for (const img of mapa1.rutas) {
                tiles[img] = loadImage(img)
            }
            sprites.tiles = tiles
        }

        function windowResized() {
            css_canvas()
        }

        function css_canvas() {
            let horizontal = windowWidth > windowHeight
            let w, h

            if (horizontal) {
                h = 384
                w = h * 16 / 9
            } else {
                w = 384
                h = w * 16 / 9
            }

            resizeCanvas(
                w,
                h
            );
            let x = (windowWidth - width) / 2
            let y = (windowHeight - height) / 2
            canvas.position(x, y)

            let sx = windowWidth / width
            let sy = windowHeight / height
            s = min(sx, sy)
            canvas.style(
                "transform",
                "scale(" + s + ")"
            )
            canvas.style(
                "image-rendering",
                "pixelated"
            )
            document.getElementById("menu-inicio").style.transformOrigin = "center center"
            document.getElementById("menu-inicio").style.transform = `scale(${s})`
            document.getElementById("menu-inicio").style.width = width + "px"
            document.getElementById("menu-inicio").style.height = height + "px"
            document.getElementById("menu-inicio").style.left = x + "px"
            document.getElementById("menu-inicio").style.top = y + "px"
        }

        FPS = -1;

        function contadorFPS() {
            if (FPS != -1) {
                return;
            }
            FPS = 0
            tiempo_ref = millis();
            fps_ref = frameCount;

            setInterval(calculador, 1000)

            function calculador() {
                seg_transc = (millis() - tiempo_ref) / 1000

                if (seg_transc >= 1) {
                    fps_transc = frameCount - fps_ref
                    FPS = (fps_transc / seg_transc).toFixed(2)
                    //reiniciar referencias
                    tiempo_ref = millis()
                    fps_ref = frameCount
                }
            }
        }

        function setup() {
            canvas = createCanvas(1280, 720)
            pixelDensity(1)
            sprites.personaje.quieto.derecha.aframe = 0
            sprites.personaje.quieto.izquierda.aframe = 0
            sprites.personaje.quieto.abajo.aframe = 0
            sprites.personaje.quieto.arriba.aframe = 0
            sprites.personaje.caminando.derecha.aframe = 0
            sprites.personaje.caminando.izquierda.aframe = 0
            sprites.personaje.caminando.abajo.aframe = 0
            sprites.personaje.caminando.arriba.aframe = 0
            css_canvas()
            noSmooth()
            imapa = new Mapa(mapa1)
            jugador = new Jugador()
            jugador.x = imapa.guia.matriz[0].length * ESCALA_UNIDAD / 2
            jugador.y = imapa.guia.matriz.length * ESCALA_UNIDAD / 2
            contadorFPS()
        }

        function draw() {
            background("black")
            push()
            translate(width / 2, height / 2)
            translate(-jugador.x, -jugador.y)
            imapa.draw()
            jugador.draw()
            pop()
            textAlign(LEFT, TOP)
            fill("white")
            stroke("black")
            text(FPS + " FPS", 10, 10)
        }


        let tiempo_intervalo_doublePressKey = 500
        let últimaPresiónTecla_doublePressKey = 0
        let últimaTecla_doublePressKey = 0

        function doubleKeyPressed(key) {
            jugador.doubleKeyPressed(key)
        }

        function keyPressed() {
            if (keyCode == últimaTecla_doublePressKey) {
                if (millis() - últimaPresiónTecla_doublePressKey <= tiempo_intervalo_doublePressKey) {
                    doubleKeyPressed(keyCode)
                }
                últimaPresiónTecla_doublePressKey = millis()
            } else {
                últimaTecla_doublePressKey = keyCode
            }
            if (keyCode == ESCAPE) {
                let menu_inicio = document.getElementById("menu-inicio")
                let menu_inicio_display = menu_inicio.style.display
                if (menu_inicio_display == "flex") {
                    menu_inicio.style.display = "none"
                    loop()
                } else {
                    menu_inicio.style.display = "flex"
                    noLoop()
                }
            }
        }

        function keyReleased() {
            jugador.keyReleased()
        }
    </script>
</body>

</html>